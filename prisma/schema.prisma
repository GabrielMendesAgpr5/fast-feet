generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

enum UserRole {
  ADMIN
  DELIVERYMAN
}

enum OrderStatus {
  WAITING
  WITHDRAWN
  DELIVERED
  RETURNED
}

model User {
  id       String   @id
  name     String
  cpf      String   @unique
  password String
  role     UserRole @default(DELIVERYMAN)

  // Entregas realizadas por este usuário
  deliveries Order[]

  // Notificações recebidas
  notifications Notification[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("users")
}

model Recipient {
  id    String  @id
  name  String
  email String? // Opcional, útil para notificações

  // Endereço
  street     String
  number     String
  complement String?
  city       String
  state      String
  zipCode    String  @map("zip_code")

  // Geolocalização para "buscar próximos"
  latitude  Decimal
  longitude Decimal

  orders Order[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("recipients")
}

model Order {
  id      String      @id @default(uuid())
  product String // Nome do produto/encomenda
  status  OrderStatus @default(WAITING)

  // Datas de controle
  availableAt DateTime? @default(now()) @map("available_at") // Data que ficou disponível (Aguardando)
  withdrawnAt DateTime? @map("withdrawn_at") // Data da retirada
  deliveredAt DateTime? @map("delivered_at") // Data da entrega
  returnedAt  DateTime? @map("returned_at") // Data da devolução

  // Chaves estrangeiras
  recipientId String    @map("recipient_id")
  recipient   Recipient @relation(fields: [recipientId], references: [id])

  deliverymanId String? @map("deliveryman_id")
  deliveryman   User?   @relation(fields: [deliverymanId], references: [id])

  // Foto da assinatura/entrega (obrigatório apenas ao entregar)
  signatureId String?     @unique @map("signature_id")
  signature   Attachment? @relation(fields: [signatureId], references: [id])

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("orders")
}

model Attachment {
  id    String @id @default(uuid())
  title String
  url   String

  // Relacionamento com Order (se for uma foto de assinatura)
  order Order?

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("attachments")
}

model Notification {
  id          String    @id @default(uuid())
  recipientId String    @map("recipient_id") // ID do usuário que recebe a notificação
  title       String
  content     String
  readAt      DateTime? @map("read_at")

  user User @relation(fields: [recipientId], references: [id])

  createdAt DateTime @default(now()) @map("created_at")

  @@map("notifications")
}
